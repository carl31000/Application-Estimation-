<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estimation rapide – Lots travaux</title>
<meta name="color-scheme" content="dark">
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0d10;color:#e9eef7;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .toolbar{position:sticky;top:0;background:#0b0d10e6;border-bottom:1px solid #232830;padding:10px 20px;display:flex;gap:8px;align-items:center;z-index:5}
  .title{font-weight:600;font-size:18px;margin-right:auto}
  .btn{background:#1f2430;border:1px solid #2b3340;color:#e9eef7;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#2a3140}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:16px 0}
  .inp,.sel{background:#1f2430;border:1px solid #2b3340;border-radius:10px;color:#e9eef7;padding:10px;width:100%}
  .card{border:1px solid #2b3340;border-radius:16px;margin:14px 0;overflow:hidden}
  .cardh{background:#171a1f;border-bottom:1px solid #2b3340;padding:12px 14px;font-weight:600}
  .row{display:grid;grid-template-columns:5fr 1.6fr 1.6fr 2fr;gap:10px;align-items:end;padding:12px 14px;border-top:1px solid #232830}
  .muted{color:#a9b4c0;font-size:12px}
  .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
  .tbox{border:1px solid #2b3340;border-radius:16px;padding:12px 14px}
  .tbox .big{font-size:22px;font-weight:700}
  .hl{color:#9bc9ff}
  details{border:1px solid #2b3340;border-radius:16px;padding:12px 14px}
  summary{cursor:pointer}
</style>
</head>
<body>
  <div class="toolbar">
    <div class="title">Estimation rapide – Lots travaux</div>
    <button class="btn" id="resetBtn">Réinitialiser</button>
    <button class="btn" id="exportBtn">Exporter CSV</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <input class="inp" id="client" placeholder="Client">
      <input class="inp" id="chantier" placeholder="Chantier">
      <input class="inp" id="ref" placeholder="Référence / N° Estimation">
    </div>

    <div class="grid" style="grid-template-columns:auto 140px 140px;">
      <select class="sel" id="filter"></select>
      <input class="inp" id="coef" type="number" step="0.01" min="0" value="1" title="Coefficient global">
      <select class="sel" id="tva">
        <option value="0.055">TVA 5,5%</option>
        <option value="0.1" selected>TVA 10%</option>
        <option value="0.2">TVA 20%</option>
      </select>
    </div>

    <div id="lotsContainer"></div>

    <div class="totals">
      <div class="tbox">
        <div class="muted">Total HT</div>
        <div class="big" id="totHT">0,00 €</div>
      </div>
      <div class="tbox">
        <div class="muted">TVA</div>
        <div class="big" id="totTVA">0,00 €</div>
      </div>
      <div class="tbox">
        <div class="muted">Total TTC</div>
        <div class="big hl" id="totTTC">0,00 €</div>
      </div>
    </div>

    <div style="margin-top:16px">
      <details>
        <summary>Rappels terrain (exemples)</summary>
        <ul>
          <li>Carrelage sol : primaire + ragréage si support irrégulier.</li>
          <li>Électricité : circuits spécialisés (LV, four, plaque) = lignes directes tableau.</li>
          <li>Plomberie : WC → évacuation PVC ≥100 mm sur colonne principale.</li>
          <li>Peinture : impression avant finition ; boiseries à compter par face.</li>
          <li>Parquet : utilise les +values (contrecollé, massif…) pour ajuster le prix au m².</li>
        </ul>
      </details>
    </div>
  </div>

<script>
const currency = n => (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});

const BASE_ITEMS = [
  { lot: "Démolition", items: [
    { label:"Dépose cuisine et sanitaires", unite:"u",   pu:480 },
    { label:"Dépose chauffage (radiateurs, chaudière)", unite:"u", pu:420 },
    { label:"Dépose carrelage", unite:"m²", pu:32 },
    { label:"Dépose cloison briquette", unite:"m²", pu:50 },
    { label:"Dépose porte et cadre", unite:"u", pu:60 },
  ]},
  { lot: "Plâtrerie / Isolation", items: [
    { label:"Plafond suspendu BA13", unite:"m²", pu:32 },
    { label:"Doublage périphérique BA13", unite:"m²", pu:32 },
    { label:"Laine de verre périphérique", unite:"m²", pu:16 },
    { label:"Doublage mur voisin BA13", unite:"m²", pu:32 },
    { label:"Laine de verre mur voisin", unite:"m²", pu:12 },
    { label:"Doublage demi-still", unite:"m²", pu:32 },
    { label:"Cloison 72/48 BA13", unite:"m²", pu:34 },
    { label:"Isolation cloison laine 45mm", unite:"m²", pu:7.15 },
    { label:"Joint plaque plâtre", unite:"m²", pu:9.5 },
    { label:"Forfait bandes armées", unite:"u", pu:500 },
  ]},
  { lot: "Menuiserie", items: [
    { label:"Porte âme pleine", unite:"u", pu:180 },
    { label:"Bloc porte galandage", unite:"u", pu:980 },
  ]},
  { lot: "Peinture", items: [
    { label:"Préparation supports existants", unite:"m²", pu:5 },
    { label:"Ratissage complet murs", unite:"m²", pu:10 },
    { label:"Couche impression", unite:"m²", pu:5 },
    { label:"Peinture finition velours", unite:"m²", pu:19 },
    { label:"Peinture boiseries (par face)", unite:"u", pu:70 },
    { label:"Peinture plinthes", unite:"ml", pu:9 },
    { label:"Forfait joints acrylique", unite:"u", pu:400 },
  ]},
  { lot: "Sols (parquet)", items: [
    { label:"Ponçage parquet", unite:"m²", pu:22 },
    { label:"Application fond dur", unite:"m²", pu:10 },
    { label:"Vitrification parquet (2 couches)", unite:"m²", pu:28 },
    { label:"Plinthe MDF 10 cm", unite:"ml", pu:14 },
    // + value simple demandée
    { label:"+ Value parquet contrecollé (fourniture + pose)", unite:"m²", pu:30 },
  ]},
  { lot: "Carrelage", items: [
    { label:"Primaire d'accroche (avant ragréage)", unite:"m²", pu:10 },
    { label:"Ragréage fibré 1 cm (max)", unite:"m²", pu:22 },
    { label:"Natte de désolidarisation", unite:"m²", pu:21 },
    { label:"Fourniture carrelage 75×75", unite:"m²", pu:30 },
    { label:"Pose carrelage sol", unite:"m²", pu:65 },
    { label:"Joint carrelage", unite:"m²", pu:25 },
    { label:"Barre de seuil", unite:"u", pu:90 },
  ]},
  { lot: "Plomberie", items: [
    { label:"Alimentation eau (PER/multicouche)", unite:"u", pu:140 },
    { label:"Alimentation eau chaud/froid", unite:"u", pu:210 },
    { label:"Évacuation eau PVC <100mm", unite:"u", pu:180 },
    { label:"Évacuation eau PVC ≥100mm", unite:"u", pu:210 },
    { label:"Siphon évacuation", unite:"u", pu:80 },
    { label:"Modification nourrice", unite:"u", pu:700 },
  ]},
  { lot: "Électricité", items: [
    { label:"Prise 2P+T", unite:"u", pu:70 },
    { label:"Va-et-vient + plafonnier (DCL)", unite:"u", pu:110 },
    { label:"Alimentation éclairage simple (DCL)", unite:"u", pu:90 },
    { label:"Prise en ligne directe tableau", unite:"u", pu:110 },
    { label:"Alimentation VMC", unite:"u", pu:90 },
    { label:"Spot / applique supplémentaire", unite:"u", pu:35 },
    { label:"Mise en sécurité électrique", unite:"u", pu:280 },
    { label:"Frais de saignée + rebouchage", unite:"u", pu:1400 },
  ]},
  { lot: "Climatisation / VMC", items: [
    { label:"Climatisation gainable complète", unite:"u", pu:4150 },
    { label:"VMC hygroréglable complète", unite:"u", pu:750 },
  ]},
];

let state = JSON.parse(localStorage.getItem('estimation_state')||'null') || {
  lots: BASE_ITEMS,
  coef: 1,
  tva: 0.10,
  client: "", chantier: "", ref: "", filter: "Tous",
};

const els = {
  filter: document.getElementById('filter'),
  coef: document.getElementById('coef'),
  tva: document.getElementById('tva'),
  client: document.getElementById('client'),
  chantier: document.getElementById('chantier'),
  ref: document.getElementById('ref'),
  lotsContainer: document.getElementById('lotsContainer'),
  totHT: document.getElementById('totHT'),
  totTVA: document.getElementById('totTVA'),
  totTTC: document.getElementById('totTTC'),
  resetBtn: document.getElementById('resetBtn'),
  exportBtn: document.getElementById('exportBtn'),
};

function save(){ localStorage.setItem('estimation_state', JSON.stringify(state)); }
function calcTotals(){
  let ht = 0;
  state.lots.forEach(l=>l.items.forEach(it=>{
    const qty = Number(it.qty||0);
    ht += qty * Number(it.pu||0) * Number(state.coef||1);
  }));
  const tvaAmt = ht * Number(state.tva||0);
  els.totHT.textContent = currency(ht);
  els.totTVA.textContent = currency(tvaAmt);
  els.totTTC.textContent = currency(ht + tvaAmt);
}
function renderFilter(){
  els.filter.innerHTML = "";
  const optAll = document.createElement('option'); optAll.textContent="Tous"; els.filter.appendChild(optAll);
  state.lots.forEach(l=>{
    const o = document.createEl
