<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Estimation rapide – Price Book consolidé</title>
<meta name="color-scheme" content="dark">
<style>
  :root { color-scheme: dark; }
  *{box-sizing:border-box}
  body{margin:0;background:#0b0d10;color:#e9eef7;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  .toolbar{position:sticky;top:0;background:#0b0d10e6;border-bottom:1px solid #232830;padding:10px 20px;display:flex;gap:8px;align-items:center;z-index:5}
  .title{font-weight:700;font-size:18px;margin-right:auto}
  .btn{background:#1f2430;border:1px solid #2b3340;color:#e9eef7;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#2a3140}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:16px 0}
  .inp,.sel{background:#1f2430;border:1px solid #2b3340;border-radius:10px;color:#e9eef7;padding:10px;width:100%}
  .card{border:1px solid #2b3340;border-radius:16px;margin:14px 0;overflow:hidden}
  .cardh{background:#171a1f;border-bottom:1px solid #2b3340;padding:12px 14px;font-weight:600}
  .row{display:grid;grid-template-columns:5fr 1.4fr 1.4fr 2fr;gap:10px;align-items:end;padding:12px 14px;border-top:1px solid #232830}
  .muted{color:#a9b4c0;font-size:12px}
  .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px}
  .tbox{border:1px solid #2b3340;border-radius:16px;padding:12px 14px}
  .tbox .big{font-size:22px;font-weight:700}
  .hl{color:#9bc9ff}
  details{border:1px solid #2b3340;border-radius:16px;padding:12px 14px}
  summary{cursor:pointer}
  #err{display:none;position:sticky;top:0;z-index:20;background:#3a1f1f;color:#ffd9d9;border-bottom:1px solid #552b2b;padding:10px 20px;font-size:14px}
  #err b{color:#fff}
</style>
</head>
<body>
  <div id="err"></div>
  <div class="toolbar">
    <div class="title">Estimation rapide – Price Book consolidé</div>
    <button class="btn" id="resetBtn">Réinitialiser</button>
    <button class="btn" id="exportBtn">Exporter CSV</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <input class="inp" id="client" placeholder="Client">
      <input class="inp" id="chantier" placeholder="Chantier">
      <input class="inp" id="ref" placeholder="Référence / N° Estimation">
    </div>

    <div class="grid" style="grid-template-columns:auto 140px 140px;">
      <select class="sel" id="filter"></select>
      <input class="inp" id="coef" type="number" step="0.01" min="0" value="1" title="Coefficient global">
      <select class="sel" id="tva">
        <option value="0.055">TVA 5,5%</option>
        <option value="0.1" selected>TVA 10%</option>
        <option value="0.2">TVA 20%</option>
      </select>
    </div>

    <div id="lotsContainer"></div>

    <div class="totals">
      <div class="tbox">
        <div class="muted">Total HT</div>
        <div class="big" id="totHT">0,00 €</div>
      </div>
      <div class="tbox">
        <div class="muted">TVA</div>
        <div class="big" id="totTVA">0,00 €</div>
      </div>
      <div class="tbox">
        <div class="muted">Total TTC</div>
        <div class="big hl" id="totTTC">0,00 €</div>
      </div>
    </div>

    <div style="margin-top:16px">
      <details>
        <summary>Rappels terrain (exemples)</summary>
        <ul>
          <li>Carrelage sol : primaire + ragréage si support irrégulier.</li>
          <li>Électricité : circuits spécialisés (LV, four, plaque) → lignes directes tableau.</li>
          <li>Plomberie : WC → évacuation PVC ≥100 mm sur colonne principale.</li>
          <li>Peinture : impression avant finition ; boiseries à compter par face.</li>
          <li>Parquet : utiliser les +values (contrecollé, massif…) pour ajuster au m².</li>
        </ul>
      </details>
    </div>
  </div>

<script>
(function(){
  // Affichage propre des erreurs au lieu d'un écran blanc
  window.addEventListener("error", function(e){
    const err = document.getElementById("err");
    err.style.display="block";
    err.innerHTML = "<b>Erreur JavaScript :</b> " + (e.message || e.error);
  });

  const currency = n => (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});

  // ========================
  // PRICE BOOK CONSOLIDÉ
  // ========================
  const BASE_ITEMS = [
    { lot:"Démolition", items:[
      { label:"Dépose cuisine et équipements sanitaires", unite:"u",   pu:350 },
      { label:"Dépose réseaux de chauffage (radiateurs/chaudière)", unite:"u", pu:320 },
      { label:"Dépose carrelage existant", unite:"m²", pu:32 },
      { label:"Dépose faïence existante", unite:"m²", pu:25 },
      { label:"Dépose cloison briquette + évacuation", unite:"m²", pu:50 },
      { label:"Dépose cadre + porte (avec évacuation)", unite:"u", pu:60 },
      { label:"Dépose moquette (avec évacuation)", unite:"u", pu:300 },
      { label:"Frais de déchèterie / évacuation gravats", unite:"m³", pu:280 },
      { label:"Création / condamnation ouverture/porte (encadrement)", unite:"u", pu:110 }
    ]},

    { lot:"Plâtrerie / Isolation", items:[
      { label:"Faux-plafond BA13 standard (non démontable)", unite:"m²", pu:34 },
      { label:"Doublage périphérique BA13 (non isolé)", unite:"m²", pu:32 },
      { label:"Doublage périphérique BA13 (isolé)", unite:"m²", pu:35 },
      { label:"Laine de verre R≈3,15 (100 mm) – murs périphériques", unite:"m²", pu:16 },
      { label:"Laine de verre R≈1,85 (70 mm) – murs voisins", unite:"m²", pu:12 },
      { label:"Cloison 72/48 BA13 (montants doubles si H>2,50 m)", unite:"m²", pu:36 },
      { label:"Isolation cloison (laine 45 mm)", unite:"m²", pu:7.15 },
      { label:"+ Value BA13 hydrofuge (pièce humide)", unite:"m²", pu:9.5 },
      { label:"Encadrement de menuiserie / caisson / retombée", unite:"u", pu:120 },
      { label:"Traitement des joints plaques de plâtre", unite:"m²", pu:9.5 },
      { label:"Forfait bandes armées", unite:"u", pu:300 },
      { label:"Bloc-porte alvéolaire 73 cm (fourniture + pose)", unite:"u", pu:180 },
      { label:"Châssis porte à galandage 73 cm (hors habillage/poignée)", unite:"u", pu:630 }
    ]},

    { lot:"Peinture", items:[
      { label:"Détapissage (forfait)", unite:"u", pu:900 },
      { label:"Préparation supports (rebouchage + ponçage)", unite:"m²", pu:6 },
      { label:"Ratissage complet des murs (2 passes)", unite:"m²", pu:12 },
      { label:"Application couche impression", unite:"m²", pu:6 },
      { label:"Peinture finition velours (2 couches)", unite:"m²", pu:15 },
      { label:"Peinture boiseries (par face)", unite:"u", pu:70 },
      { label:"Peinture plinthes", unite:"ml", pu:9 },
      { label:"Joints acryliques menuiseries (forfait)", unite:"u", pu:400 },
      { label:"+ Value plafond grande hauteur (>2,8 m)", unite:"m²", pu:5 }
    ]},

    { lot:"Sols – Parquet / SPC", items:[
      { label:"Ponçage de parquet", unite:"m²", pu:22 },
      { label:"Fond dur (impression)", unite:"m²", pu:10 },
      { label:"Vitrification parquet (2 couches)", unite:"m²", pu:28 },
      { label:"Fourniture sol SPC (gamme moyenne)", unite:"m²", pu:30 },
      { label:"Sous-couche / colle (SPC ou pose collée)", unite:"m²", pu:15 },
      { label:"Pose revêtement (parquet/SPC)", unite:"m²", pu:30 },
      { label:"Plinthes MDF 8–10 cm (fourniture + pose)", unite:"ml", pu:14 },
      { label:"+ Value parquet contrecollé (fourniture + pose)", unite:"m²", pu:30 },
      { label:"+ Value parquet massif (fourniture + pose)", unite:"m²", pu:60 }
    ]},

    { lot:"Carrelage / Faïence", items:[
      { label:"Primaire d’accroche (avant ragréage)", unite:"m²", pu:10 },
      { label:"Ragréage fibré (ép. ≤1 cm)", unite:"m²", pu:22 },
      { label:"Natte de désolidarisation", unite:"m²", pu:21 },
      { label:"Fourniture carrelage sol 60–75 cm (moyenne)", unite:"m²", pu:30 },
      { label:"Pose carrelage sol", unite:"m²", pu:65 },
      { label:"Joints carrelage", unite:"m²", pu:25 },
      { label:"Barre de seuil (fourniture + pose)", unite:"u", pu:90 },
      { label:"SPEC douche + primaire (étanchéité)", unite:"m²", pu:20 },
      { label:"Faïence murale – pose", unite:"m²", pu:65 },
      { label:"Faïence – baguette/retour d’angle", unite:"ml", pu:12 },
      { label:"+ Value carrelage grand format (>90 cm) – pose", unite:"m²", pu:15 },
      { label:"+ Value carrelage imitation parquet – pose", unite:"m²", pu:12 }
    ]},

    { lot:"Plomberie – Réseaux", items:[
      { label:"Alimentation eau froide (PER encastré / multicouche apparent)", unite:"u", pu:140 },
      { label:"Alimentation chaud/froid (point d’eau)", unite:"u", pu:210 },
      { label:"+ Value corps encastré (mitigeur/colonne encastrée)", unite:"u", pu:190 },
      { label:"Évacuation PVC <100 mm (appareillage)", unite:"u", pu:180 },
      { label:"Évacuation PVC ≥100 mm (raccord colonne)", unite:"u", pu:210 },
      { label:"Siphon évacuation (pose)", unite:"u", pu:80 },
      { label:"Modification / réalignement réseaux cuisine", unite:"u", pu:300 }
    ]},

    { lot:"Plomberie – Pose d’équipements", items:[
      { label:"Pose WC (classique)", unite:"u", pu:120 },
      { label:"Pose WC suspendu", unite:"u", pu:220 },
      { label:"Pose receveur douche + étanchéité + accessoires", unite:"u", pu:170 },
      { label:"Pose colonne de douche", unite:"u", pu:90 },
      { label:"Pose meuble vasque simple + étanchéité", unite:"u", pu:160 },
      { label:"Pose mitigeur de meuble vasque", unite:"u", pu:50 }
    ]},

    { lot:"Électricité", items:[
      { label:"Prise 2P+T (créer)", unite:"u", pu:70 },
      { label:"Va-et-vient + plafonnier DCL", unite:"u", pu:110 },
      { label:"Éclairage simple allumage (plafond DCL)", unite:"u", pu:90 },
      { label:"Spot / applique supplémentaire", unite:"u", pu:35 },
      { label:"Ligne directe tableau (LV / Four / MO / Hotte / Frigo)", unite:"u", pu:110 },
      { label:"Alimentation plaque cuisson 32A", unite:"u", pu:110 },
      { label:"Alimentation VMC", unite:"u", pu:90 },
      { label:"Mise en sécurité électrique (dépose appareillage/réseaux)", unite:"u", pu:280 },
      { label:"Frais de saignée + rebouchage (forfait chantier)", unite:"u", pu:1400 }
    ]},

    { lot:"Climatisation / VMC", items:[
      { label:"Climatisation gainable – fourniture + pose (ensemble)", unite:"u", pu:4150 },
      { label:"VMC simple flux hygroréglable (kit complet + pose)", unite:"u", pu:750 }
    ]}
  ];

  // ========================
  // APP
  // ========================
  let state = null;
  try {
    state = JSON.parse(localStorage.getItem('estimation_state')||'null');
  } catch(_) {}
  if(!state){
    state = { lots: BASE_ITEMS, coef:1, tva:0.10, client:"", chantier:"", ref:"", filter:"Tous" };
  }

  const els = {
    filter: document.getElementById('filter'),
    coef: document.getElementById('coef'),
    tva: document.getElementById('tva'),
    client: document.getElementById('client'),
    chantier: document.getElementById('chantier'),
    ref: document.getElementById('ref'),
    lotsContainer: document.getElementById('lotsContainer'),
    totHT: document.getElementById('totHT'),
    totTVA: document.getElementById('totTVA'),
    totTTC: document.getElementById('totTTC'),
    resetBtn: document.getElementById('resetBtn'),
    exportBtn: document.getElementById('exportBtn'),
    err: document.getElementById('err')
  };

  function showErr(msg){
    els.err.style.display="block";
    els.err.innerHTML = "<b>Erreur JavaScript :</b> "+msg;
  }
  function save(){
    try{ localStorage.setItem('estimation_state', JSON.stringify(state)); }
    catch(e){ showErr("Stockage local indisponible : "+e.message); }
  }
  function calcTotals(){
    let ht = 0;
    state.lots.forEach(l=>l.items.forEach(it=>{
      const qty = Number(it.qty||0);
      ht += qty * Number(it.pu||0) * Number(state.coef||1);
    }));
    const tvaAmt = ht * Number(state.tva||0);
    els.totHT.textContent = currency(ht);
    els.totTVA.textContent = currency(tvaAmt);
    els.totTTC.textContent = currency(ht + tvaAmt);
  }
  function renderFilter(){
    els.filter.innerHTML = "";
    const optAll = document.createElement('option'); optAll.textContent="Tous"; els.filter.appendChild(optAll);
    state.lots.forEach(l=>{
      const o = document.createElement('option'); o.textContent=l.lot; els.filter.appendChild(o);
    });
    els.filter.value = state.filter || "Tous";
  }
  function rowItem(lotIdx,itemIdx,it){
    const row = document.createElement('div'); row.className='row';
    const c0 = document.createElement('div');
    c0.innerHTML = `<div>${it.label}</div><div class="muted">Unité: ${it.unite}</div>`;
    const pu = document.createElement('input'); pu.type='number'; pu.className='inp'; pu.value=it.pu;
    const qty = document.createElement('input'); qty.type='number'; qty.step='0.01'; qty.min='0'; qty.className='inp'; qty.value = it.qty??''; qty.placeholder='0';
    const total = document.createElement('div'); total.style.textAlign='right';
    const updateTotal = ()=>{ const t = (Number(it.qty||0)*Number(it.pu||0)*Number(state.coef||1)); total.innerHTML = `<div class="muted">Total ligne HT</div><div class="big" style="font-size:16px">${currency(t)}</div>`; };
    pu.oninput  = e=>{ state.lots[lotIdx].items[itemIdx].pu  = Number(e.target.value)||0; save(); calcTotals(); updateTotal(); };
    qty.oninput = e=>{ state.lots[lotIdx].items[itemIdx].qty = Number(e.target.value)||0; save(); calcTotals(); updateTotal(); };
    updateTotal();
    row.append(c0, pu, qty, total);
    return row;
  }
  function renderLots(){
    els.lotsContainer.innerHTML = "";
    const list = state.filter==="Tous" ? state.lots : state.lots.filter(l=>l.lot===state.filter);
    list.forEach((lot)=>{
      const lotIdx = state.lots.indexOf(lot);
      const card = document.createElement('div'); card.className='card';
      const h = document.createElement('div'); h.className='cardh'; h.textContent = lot.lot; card.appendChild(h);
      lot.items.forEach((it, itemIdx)=> card.appendChild(rowItem(lotIdx,itemIdx,it)));
      els.lotsContainer.appendChild(card);
    });
    calcTotals();
  }
  function bind(){
    els.client.value = state.client; els.chantier.value = state.chantier; els.ref.value = state.ref;
    els.coef.value = state.coef; els.tva.value = String(state.tva);
    els.client.oninput   = e=>{ state.client  = e.target.value; save(); };
    els.chantier.oninput = e=>{ state.chantier= e.target.value; save(); };
    els.ref.oninput      = e=>{ state.ref     = e.target.value; save(); };
    els.coef.oninput     = e=>{ state.coef    = Number(e.target.value)||0; save(); calcTotals(); };
    els.tva.onchange     = e=>{ state.tva     = Number(e.target.value)||0; save(); calcTotals(); };
    els.filter.onchange  = e=>{ state.filter  = e.target.value; save(); renderLots(); };
    els.resetBtn.onclick = ()=>{
      state = { lots: JSON.parse(JSON.stringify(BASE_ITEMS)), coef:1, tva:0.10, client:"", chantier:"", ref:"", filter:"Tous"};
      save(); renderFilter(); bind(); renderLots();
    };
    els.exportBtn.onclick = ()=>{
      const rows = [];
      rows.push(["Lot","Prestation","Unité","PU HT","Coefficient","Quantité","Total HT"].join(";"));
      state.lots.forEach(l=>l.items.forEach(it=>{
        const qty = Number(it.qty||0);
        const total = qty*Number(it.pu||0)*Number(state.coef||1);
        if(qty>0) rows.push([l.lot,it.label,it.unite,String(it.pu),String(state.coef),String(qty),String(total)].join(";"));
      }));
      let ht=0; state.lots.forEach(l=>l.items.forEach(it=>{ht+=Number(it.qty||0)*Number(it.pu||0)*Number(state.coef||1)}));
      const tvaAmt = ht*Number(state.tva||0);
      rows.push(["","","","","TOTAL HT","",String(ht)].join(";"));
      rows.push(["","","","","TVA","",String(tvaAmt)].join(";"));
      rows.push(["","","","","TOTAL TTC","",String(ht+tvaAmt)].join(";"));
      const blob = new Blob(["\ufeff"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=(state.ref||"estimation")+"-pricebook.csv"; a.click();
      URL.revokeObjectURL(url);
    };
  }

  // Démarrage
  try{
    renderFilter();
    bind();
    renderLots();
  }catch(e){
    showErr(e.message || e);
    console.error(e);
  }
})();
</script>
</body>
</html>