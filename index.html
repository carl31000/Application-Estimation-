<script>
const currency = n => (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});

/* =========================
   PRICE BOOK CONSOLIDÉ
========================= */
const BASE_ITEMS = [ /* … (inchangé, tout le catalogue) … */ ];

/* =========================
   APP
========================= */
let state = JSON.parse(localStorage.getItem('estimation_state')||'null') || {
  lots: BASE_ITEMS,
  coef: 1,
  tva: 0.10,
  client: "", chantier: "", ref: "", filter: "Tous",
};

const els = {
  filter: document.getElementById('filter'),
  coef: document.getElementById('coef'),
  tva: document.getElementById('tva'),
  client: document.getElementById('client'),
  chantier: document.getElementById('chantier'),
  ref: document.getElementById('ref'),
  lotsContainer: document.getElementById('lotsContainer'),
  totHT: document.getElementById('totHT'),
  totTVA: document.getElementById('totTVA'),
  totTTC: document.getElementById('totTTC'),
  resetBtn: document.getElementById('resetBtn'),
  exportBtn: document.getElementById('exportBtn'),
};

function save(){ localStorage.setItem('estimation_state', JSON.stringify(state)); }
function calcTotals(){
  let ht = 0;
  state.lots.forEach(l=>l.items.forEach(it=>{
    const qty = Number(it.qty||0);
    ht += qty * Number(it.pu||0) * Number(state.coef||1);
  }));
  const tvaAmt = ht * Number(state.tva||0);
  els.totHT.textContent = currency(ht);
  els.totTVA.textContent = currency(tvaAmt);
  els.totTTC.textContent = currency(ht + tvaAmt);
}
function renderFilter(){
  els.filter.innerHTML = "";
  const optAll = document.createElement('option'); optAll.textContent="Tous"; els.filter.appendChild(optAll);
  state.lots.forEach(l=>{
    const o = document.createElement('option'); o.textContent=l.lot; els.filter.appendChild(o);
  });
  els.filter.value = state.filter || "Tous";
}
function rowItem(lotIdx,itemIdx,it){
  const row = document.createElement('div'); row.className='row';
  const c0 = document.createElement('div');
  c0.innerHTML = `<div>${it.label}</div><div class="muted">Unité: ${it.unite}</div>`;
  const pu = document.createElement('input'); pu.type='number'; pu.className='inp'; pu.value=it.pu;
  const qty = document.createElement('input'); qty.type='number'; qty.step='0.01'; qty.min='0'; qty.className='inp'; qty.value = it.qty??''; qty.placeholder='0';
  const total = document.createElement('div'); total.style.textAlign='right';
  const updateTotal = ()=>{ const t = (Number(it.qty||0)*Number(it.pu||0)*Number(state.coef||1)); total.innerHTML = `<div class="muted">Total ligne HT</div><div class="big" style="font-size:16px">${currency(t)}</div>`; };
  pu.oninput  = e=>{ state.lots[lotIdx].items[itemIdx].pu  = Number(e.target.value)||0; save(); calcTotals(); updateTotal(); };
  qty.oninput = e=>{ state.lots[lotIdx].items[itemIdx].qty = Number(e.target.value)||0; save(); calcTotals(); updateTotal(); };
  updateTotal();
  row.append(c0, pu, qty, total);
  return row;
}
function renderLots(){
  els.lotsContainer.innerHTML = "";
  const list = state.filter==="Tous" ? state.lots : state.lots.filter(l=>l.lot===state.filter);
  list.forEach((lot)=>{
    const lotIdx = state.lots.indexOf(lot);
    const card = document.createElement('div'); card.className='card';
    const h = document.createElement('div'); h.className='cardh'; h.textContent = lot.lot; card.appendChild(h);
    lot.items.forEach((it, itemIdx)=> card.appendChild(rowItem(lotIdx,itemIdx,it)));
    els.lotsContainer.appendChild(card);
  });
  calcTotals();
}
function bind(){
  els.client.value = state.client; els.chantier.value = state.chantier; els.ref.value = state.ref;
  els.coef.value = state.coef; els.tva.value = String(state.tva);
  els.client.oninput   = e=>{ state.client  = e.target.value; save(); };
  els.chantier.oninput = e=>{ state.chantier= e.target.value; save(); };
  els.ref.oninput      = e=>{ state.ref     = e.target.value; save(); };
  els.coef.oninput     = e=>{ state.coef    = Number(e.target.value)||0; save(); calcTotals(); };
  els.tva.onchange     = e=>{ state.tva     = Number(e.target.value)||0; save(); calcTotals(); };
  els.filter.onchange  = e=>{ state.filter  = e.target.value; save(); renderLots(); };
  els.resetBtn.onclick = ()=>{
    state = { lots: JSON.parse(JSON.stringify(BASE_ITEMS)), coef:1, tva:0.10, client:"", chantier:"", ref:"", filter:"Tous"};
    save(); renderFilter(); bind(); renderLots();
  };
  els.exportBtn.onclick = ()=>{
    const rows = [];
    rows.push(["Lot","Prestation","Unité","PU HT","Coefficient","Quantité","Total HT"].join(";"));
    state.lots.forEach(l=>l.items.forEach(it=>{
      const qty = Number(it.qty||0);
      const total = qty*Number(it.pu||0)*Number(state.coef||1);
      if(qty>0) rows.push([l.lot,it.label,it.unite,String(it.pu),String(state.coef),String(qty),String(total)].join(";"));
    }));
    let ht=0; state.lots.forEach(l=>l.items.forEach(it=>{ht+=Number(it.qty||0)*Number(it.pu||0)*Number(state.coef||1)}));
    const tvaAmt = ht*Number(state.tva||0);
    rows.push(["","","","","TOTAL HT","",String(ht)].join(";"));
    rows.push(["","","","","TVA","",String(tvaAmt)].join(";"));
    rows.push(["","","","","TOTAL TTC","",String(ht+tvaAmt)].join(";"));
    const blob = new Blob(["\ufeff"+rows.join("\n")],{type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download=(state.ref||"estimation")+"-pricebook.csv"; a.click();
    URL.revokeObjectURL(url);
  };
}

renderFilter();
bind();
renderLots();
</script>
